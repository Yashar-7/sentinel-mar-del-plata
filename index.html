<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMART TECH - SENTINEL V1.2.5</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --neon-blue: #00eaff;
            --neon-red: #ff3131;
            --panel-bg: rgba(0, 5, 10, 0.9);
            --border-glow: rgba(0, 234, 255, 0.4);
            --scan-color: rgba(0, 234, 255, 0.15);
            --emergency-filter: none;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: #000;
            color: var(--neon-blue);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            text-transform: uppercase;
        }

        /* --- ESCÁNER DINÁMICO --- */
        #scanner-container {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100vh;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        #scanner-light {
            position: absolute;
            top: -20px;
            left: 50%;
            width: 180%;
            height: 150%;
            background: conic-gradient(from 180deg at 50% 0%, 
                transparent 165deg, 
                var(--scan-color) 180deg, 
                transparent 195deg);
            transform-origin: top center;
            transform: translateX(-50%) rotate(0deg);
            animation: sweep 5s ease-in-out infinite;
            filter: blur(10px);
            transition: background 0.5s ease;
        }

        @keyframes sweep {
            0% { transform: translateX(-50%) rotate(-30deg); }
            50% { transform: translateX(-50%) rotate(30deg); }
            100% { transform: translateX(-50%) rotate(-30deg); }
        }

        /* --- ESTADO DE EMERGENCIA --- */
        .emergency-active #scanner-light {
            --scan-color: rgba(255, 49, 49, 0.4);
            animation: sweep 1.5s ease-in-out infinite; /* Escaneo más rápido */
        }

        .emergency-active .main-header {
            border-bottom: 2px solid var(--neon-red);
            box-shadow: 0 0 20px rgba(255, 49, 49, 0.4);
        }

        /* --- INTERFAZ --- */
        .main-header {
            height: 70px;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-glow);
            z-index: 100;
            position: relative;
        }

        .logo-placeholder {
            font-size: 1.4em;
            font-weight: 900;
            letter-spacing: 5px;
            color: var(--neon-blue);
            text-shadow: 0 0 15px var(--neon-blue);
            transition: 0.3s;
        }

        .emergency-active .logo-placeholder {
            color: var(--neon-red);
            text-shadow: 0 0 15px var(--neon-red);
        }

        #map {
            position: absolute;
            top: 70px; bottom: 180px;
            width: 100%;
            background: #050505;
            z-index: 1;
        }

        .bottom-console {
            position: absolute;
            bottom: 0; width: 100%;
            height: 180px;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-glow);
            display: grid;
            grid-template-columns: 1fr 1fr;
            z-index: 100;
            backdrop-filter: blur(15px);
        }

        .video-box {
            position: relative;
            border-right: 1px solid var(--border-glow);
        }

        #video-feed { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; transition: 0.5s; }

        .controls-box {
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .btn-action {
            background: rgba(0, 234, 255, 0.1);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-critical {
            background: rgba(255, 49, 49, 0.1);
            border-color: var(--neon-red);
            color: var(--neon-red);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0px rgba(255, 49, 49, 0.4); }
            50% { box-shadow: 0 0 15px rgba(255, 49, 49, 0.7); }
            100% { box-shadow: 0 0 0px rgba(255, 49, 49, 0.4); }
        }

        #selector-container {
            position: fixed; inset: 0;
            background: radial-gradient(circle, #001529 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .auth-card {
            border: 1px solid var(--neon-blue);
            padding: 40px;
            text-align: center;
            background: rgba(0, 5, 15, 0.95);
            box-shadow: 0 0 40px rgba(0, 234, 255, 0.2);
        }
    </style>
</head>
<body id="sentinel-body">

    <div id="selector-container">
        <div class="auth-card">
            <div class="logo-placeholder">SENTINEL</div>
            <p style="font-size: 0.6em; margin-bottom: 30px; letter-spacing: 2px;">SMART TECH | SECURITY OVERRIDE</p>
            <button class="btn-action" style="width: 100%; margin-bottom: 15px;" onclick="iniciarSistema('responder')">ACCESO RESPUESTA</button>
            <button class="btn-action btn-critical" style="width: 100%;" onclick="iniciarSistema('citizen')">ACCESO CIUDADANO</button>
        </div>
    </div>

    <header class="main-header">
        <div class="logo-placeholder">SENTINEL</div>
        <div id="sys-status" style="font-size: 0.5em; letter-spacing: 1px;">● SYSTEM_READY | NO_THREATS</div>
    </header>

    <div id="scanner-container">
        <div id="scanner-light"></div>
    </div>

    <div id="map"></div>

    <div class="bottom-console">
        <div class="video-box">
            <video id="video-feed" autoplay playsinline></video>
            <div style="position:absolute; bottom:10px; left:10px; font-size: 9px; background: rgba(0,0,0,0.7); padding: 2px 5px;" id="cam-status">CAM_FEED: OFFLINE</div>
        </div>
        <div class="controls-box">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <div id="unit-id" style="font-size: 0.6em; color: #55aaff;">ID: ---</div>
                <div id="gps-coords" style="font-size: 0.6em; font-family: monospace;">0.00, 0.00</div>
            </div>
            <button class="btn-action" onclick="toggleCamara()">ENLACE DE VIDEO</button>
            <button class="btn-action btn-critical" onclick="enviarAlerta()">ALERTA CRÍTICA</button>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN SUPABASE
        const SUPABASE_URL = 'https://svpurpvbiujhcbiugrkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const UNIT_ID = 'SNT-' + Math.floor(Math.random() * 899 + 100);
        let map, userMarker, myRole = "";
        let stream = null;

        function iniciarSistema(rol) {
            myRole = rol;
            document.getElementById('selector-container').style.display = 'none';
            document.getElementById('unit-id').innerText = UNIT_ID + " [" + rol + "]";

            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-38.0055, -57.5426], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            startGPS();
            subscribeToUpdates();
        }

        function startGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(async pos => {
                    const { latitude: lat, longitude: lng } = pos.coords;
                    document.getElementById('gps-coords').innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

                    if (!userMarker) {
                        userMarker = L.circleMarker([lat, lng], {
                            radius: 9, fillColor: (myRole === 'citizen' ? '#ff3131' : '#00eaff'),
                            color: '#fff', weight: 2, fillOpacity: 1
                        }).addTo(map);
                        map.panTo([lat, lng]);
                    } else {
                        userMarker.setLatLng([lat, lng]);
                    }

                    await _supabase.from('unidades_live').upsert({
                        user_id: UNIT_ID, latitude: lat, longitude: lng, role: myRole
                    }, { onConflict: 'user_id' });

                }, null, { enableHighAccuracy: true });
            }
        }

        function subscribeToUpdates() {
            _supabase.channel('global-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'unidades_live' }, payload => {
                    if (payload.new && payload.new.user_id !== UNIT_ID) {
                        renderOther(payload.new);
                    }
                }).subscribe();
        }

        let others = {};
        function renderOther(data) {
            const color = (data.role === 'citizen' ? '#ff3131' : '#00eaff');
            if (others[data.user_id]) {
                others[data.user_id].setLatLng([data.latitude, data.longitude]);
            } else {
                others[data.user_id] = L.circleMarker([data.latitude, data.longitude], {
                    radius: 7, fillColor: color, color: color, fillOpacity: 0.6
                }).addTo(map);
                others[data.user_id].bindTooltip(data.user_id, { permanent: false, className: 'leaflet-tooltip' });
            }
        }

        async function toggleCamara() {
            const v = document.getElementById('video-feed');
            const s = document.getElementById('cam-status');
            if (!stream) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    v.srcObject = stream;
                    v.style.opacity = "1";
                    s.innerText = "CAM_FEED: ACTIVE"; s.style.color = "var(--neon-blue)";
                } catch(e) { alert("ERROR_CAM: NO_PERMISSION"); }
            } else {
                stream.getTracks().forEach(t => t.stop());
                stream = null; v.srcObject = null;
                v.style.opacity = "0.5";
                s.innerText = "CAM_FEED: OFFLINE"; s.style.color = "gray";
            }
        }

        function enviarAlerta() {
            const body = document.getElementById('sentinel-body');
            const status = document.getElementById('sys-status');
            
            body.classList.add('emergency-active');
            status.innerText = "● ALERT_SENT | EMERGENCY_PROTOCOL_ACTIVE";
            status.style.color = "var(--neon-red)";

            // Simulación de envío
            setTimeout(() => {
                alert("CENTRAL DE MONITOREO NOTIFICADA - UNIDADES EN CAMINO");
            }, 500);
        }
    </script>
</body>
</html>
