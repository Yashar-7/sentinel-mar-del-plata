<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENTINEL ARGENTO | REGISTRO</title>
    
    <!-- Leaflet para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ffaa;
            --secondary: #0066ff;
            --alert: #ff3300;
            --bg: #0a0c10;
        }

        body {
            background: var(--bg);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        /* Pantalla de registro */
        #pantalla-registro {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-size: 2.5rem;
            letter-spacing: 5px;
            text-shadow: 0 0 10px var(--primary);
        }

        .logo p {
            color: var(--secondary);
            letter-spacing: 2px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        input {
            width: 100%;
            background: transparent;
            border: 1px solid var(--primary);
            padding: 15px;
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            outline: none;
        }

        input:focus {
            box-shadow: 0 0 15px var(--primary);
        }

        button {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover {
            background: rgba(0, 255, 170, 0.1);
            box-shadow: 0 0 20px var(--primary);
        }

        .terminos {
            margin-top: 20px;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
        }

        /* Pantalla principal (después del registro) */
        #pantalla-principal {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        /* Modal de confirmación */
        #modal-exito {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
            border: 2px solid var(--primary);
            padding: 30px;
            text-align: center;
            z-index: 10000;
            display: none;
            max-width: 300px;
            box-shadow: 0 0 30px var(--primary);
        }

        .modal-exito-titulo {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE REGISTRO -->
    <div id="pantalla-registro">
        <div class="logo">
            <h1>SENTINEL</h1>
            <p>ARGENTO</p>
        </div>

        <div class="form-group">
            <label>NOMBRE COMPLETO</label>
            <input type="text" id="nombre" placeholder="Ej: Juan Pérez">
        </div>

        <div class="form-group">
            <label>DNI</label>
            <input type="text" id="dni" placeholder="Ej: 12345678">
        </div>

        <div class="form-group">
            <label>TELÉFONO</label>
            <input type="text" id="telefono" placeholder="Ej: 223 555-1234">
        </div>

        <div class="form-group">
            <label>DOMICILIO</label>
            <input type="text" id="domicilio" placeholder="Ej: Av. Luro 1234">
        </div>

        <button onclick="registrar()">REGISTRARME</button>

        <div class="terminos">
            AL REGISTRARME ACEPTO QUE LAS FALSAS ALERTAS<br>
            SERÁN DENUNCIADAS A LA AUTORIDAD
        </div>
    </div>

    <!-- MODAL DE ÉXITO -->
    <div id="modal-exito">
        <div class="modal-exito-titulo">✓</div>
        <p style="margin-bottom: 20px;">REGISTRO EXITOSO</p>
        <button onclick="cerrarModalRegistro()" style="margin:0">CONTINUAR</button>
    </div>

    <!-- PANTALLA PRINCIPAL (la que ya tenemos) -->
    <div id="pantalla-principal">
        <!-- Acá va el código de la app principal -->
    </div>

    <script>
        // ==============================================
        // CONFIGURACIÓN SUPABASE
        // ==============================================
        const SUPABASE_URL = 'https://svpurpvbiujhcbiugrkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==============================================
        // VARIABLES GLOBALES
        // ==============================================
        let usuarioActual = null;

        // ==============================================
        // FUNCIÓN DE REGISTRO (LO NUEVO)
        // ==============================================
        async function registrar() {
            // 1. OBTENER VALORES
            const nombre = document.getElementById('nombre').value.trim();
            const dni = document.getElementById('dni').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const domicilio = document.getElementById('domicilio').value.trim();

            // 2. VALIDAR
            if (!nombre || !dni || !telefono || !domicilio) {
                alert("COMPLETE TODOS LOS CAMPOS");
                return;
            }

            if (dni.length < 7 || dni.length > 8) {
                alert("DNI INVÁLIDO");
                return;
            }

            // 3. CREAR OBJETO USUARIO
            const usuario = {
                nombre: nombre,
                dni: dni,
                telefono: telefono,
                domicilio: domicilio,
                fecha_registro: new Date().toISOString(),
                id_unico: 'USR-' + dni + '-' + Date.now().toString().slice(-4)
            };

            try {
                // 4. GUARDAR EN SUPABASE
                const { error } = await _supabase
                    .from('ciudadanos')
                    .insert(usuario);

                if (error) throw error;

                // 5. GUARDAR LOCALMENTE (para usar después)
                localStorage.setItem('usuario_activo', JSON.stringify(usuario));
                usuarioActual = usuario;

                // 6. MOSTRAR ÉXITO
                document.getElementById('modal-exito').style.display = 'block';

            } catch (error) {
                console.error(error);
                alert("ERROR EN EL REGISTRO. ¿YA EXISTE ESE DNI?");
            }
        }

        function cerrarModalRegistro() {
            document.getElementById('modal-exito').style.display = 'none';
            
            // 7. CAMBIAR A PANTALLA PRINCIPAL
            document.getElementById('pantalla-registro').style.display = 'none';
            document.getElementById('pantalla-principal').style.display = 'flex';
            
            // 8. INICIAR LA APP PRINCIPAL
            iniciarAppPrincipal();
        }

        // ==============================================
        // VERIFICAR SI YA ESTÁ REGISTRADO
        // ==============================================
        function verificarRegistro() {
            const guardado = localStorage.getItem('usuario_activo');
            if (guardado) {
                // Ya estaba registrado, vamos directo a la app
                usuarioActual = JSON.parse(guardado);
                document.getElementById('pantalla-registro').style.display = 'none';
                document.getElementById('pantalla-principal').style.display = 'flex';
                iniciarAppPrincipal();
            }
        }

        // ==============================================
        // ACÁ VA LA APP PRINCIPAL (la que ya teníamos)
        // ==============================================
        function iniciarAppPrincipal() {
            // Copiar y pegar la app principal completa acá
            console.log("App iniciada para:", usuarioActual.nombre);
            
            // Por ahora solo mostramos mensaje
            document.getElementById('pantalla-principal').innerHTML = `
                <div style="padding:20px; text-align:center;">
                    <h1 style="color:var(--primary);">BIENVENIDO</h1>
                    <p style="color:var(--secondary);">${usuarioActual.nombre}</p>
                    <p style="margin-top:20px;">APP PRINCIPAL CARGADA</p>
                    <p style="font-size:0.8rem;">ID: ${usuarioActual.id_unico}</p>
                </div>
            `;
        }

        // ==============================================
        // AL INICIAR
        // ==============================================
        verificarRegistro();
    </script>
</body>
</html>
