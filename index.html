<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENTINEL v2.0</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --neon-blue: #00eaff; --neon-red: #ff3131; --neon-green: #39ff14;
            --bg-dark: #00050a;
        }

        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); color: var(--neon-blue);
            font-family: 'Segoe UI', sans-serif; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER (Altura fija 10%) --- */
        header {
            height: 10%; background: #000; border-bottom: 1px solid var(--neon-blue);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- CONTENEDOR PRINCIPAL (Altura fija 60%) --- */
        #main-display {
            height: 60%; width: 100%; position: relative;
            background: #000; overflow: hidden;
        }
        #map { width: 100%; height: 100%; }
        
        /* Miniatura de cámara flotante (para no robar espacio) */
        #camera-container {
            position: absolute; top: 10px; right: 10px;
            width: 120px; height: 160px; border: 1px solid var(--neon-blue);
            z-index: 1000; background: #000; display: none;
        }
        #video-feed { width: 100%; height: 100%; object-fit: cover; }

        /* --- CONSOLA DE CONTROL (Altura fija 30%) --- */
        footer {
            height: 30%; background: rgba(0, 10, 20, 0.95);
            border-top: 2px solid var(--neon-blue);
            display: flex; flex-direction: column; padding: 10px;
        }

        .status-bar { font-size: 0.7em; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .btn-group {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-grow: 1;
        }

        .btn {
            background: rgba(0, 234, 255, 0.1); border: 1px solid var(--neon-blue);
            color: var(--neon-blue); font-weight: bold; font-size: 0.8em;
            text-transform: uppercase; display: flex; align-items: center; justify-content: center;
        }
        .btn-alert { border-color: var(--neon-red); color: var(--neon-red); background: rgba(255, 0, 0, 0.1); }

        /* Estilo del Mapa Táctico */
        .leaflet-tile { filter: brightness(0.6) invert(100%) hue-rotate(180deg) contrast(1.2); }

        /* Selector de rol */
        #overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div style="text-align:center; border: 1px solid var(--neon-blue); padding: 30px;">
            <h2 style="letter-spacing:5px;">SENTINEL</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="init('civil', '#ffffff')" style="color:#fff; padding:15px;">CIVIL</button>
                <button onclick="init('repartidor', '#ff3131')" style="color:#ff3131; padding:15px;">DELIVERY</button>
                <button onclick="init('patrulla', '#00eaff')" style="color:#00eaff; padding:15px;">PATRULLA</button>
                <button onclick="init('emergencia', '#39ff14')" style="color:#39ff14; padding:15px;">MÉDICO</button>
            </div>
        </div>
    </div>

    <header>
        <div style="font-size: 0.9em; font-weight: 900; letter-spacing: 3px;">SENTINEL SYSTEM</div>
        <div id="global-status" style="font-size: 0.5em; color: var(--neon-green);">● SISTEMA ESTABLE</div>
    </header>

    <div id="main-display">
        <div id="map"></div>
        <div id="camera-container">
            <video id="video-feed" autoplay playsinline></video>
        </div>
    </div>

    <footer>
        <div class="status-bar">
            <div id="display-id">ID: ---</div>
            <div id="display-gps">GPS: BUSCANDO...</div>
        </div>
        <div class="btn-group">
            <button class="btn" onclick="toggleCamera()">CÁMARA</button>
            <button class="btn btn-alert" onclick="triggerAlert()">ALERTA</button>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://svpurpvbiujhcbiugrkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const MY_ID = 'SNT-' + Math.floor(Math.random()*900+100);
        let map, myMarker, myRole, stream;
        let units = {};

        async function init(role, color) {
            myRole = role;
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('display-id').innerText = MY_ID + " | " + role.toUpperCase();
            document.getElementById('display-id').style.color = color;

            // Mapa con zoom optimizado y tiles que permiten ver letras
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-38.0055, -57.5426], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const { latitude: lat, longitude: lng } = pos.coords;
                    document.getElementById('display-gps').innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    
                    if(!myMarker) {
                        myMarker = L.circleMarker([lat, lng], { radius: 8, color: '#fff', fillColor: color, fillOpacity: 1 }).addTo(map);
                        map.panTo([lat, lng]);
                    } else {
                        myMarker.setLatLng([lat, lng]);
                    }

                    // Sincronizar con tus columnas reales
                    _supabase.from('unidades_live').upsert({
                        id: MY_ID,
                        name: `UNIT_${MY_ID}`,
                        lat: lat,
                        ing: lng, // Tu columna 'ing'
                        status: myRole,
                        updated_at: new Date().toISOString()
                    });
                });
            }
            subscribeToRealtime();
        }

        function subscribeToRealtime() {
            _supabase.channel('public:unidades_live')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'unidades_live' }, payload => {
                if(payload.new && payload.new.id !== MY_ID) {
                    updateExternalUnit(payload.new);
                }
            }).subscribe();
        }

        function updateExternalUnit(data) {
            const colors = { 'civil': '#ffffff', 'repartidor': '#ff3131', 'patrulla': '#00eaff', 'emergencia': '#39ff14' };
            const unitColor = colors[data.status] || '#fff';

            if(units[data.id]) {
                units[data.id].setLatLng([data.lat, data.ing]);
            } else {
                units[data.id] = L.circleMarker([data.lat, data.ing], { 
                    radius: 6, color: unitColor, fillColor: unitColor, fillOpacity: 0.8 
                }).addTo(map);
            }
            checkProximityAlerts();
        }

        // LÓGICA DE LOS 3 PUNTOS (Fatibilidad 100%)
        function checkProximityAlerts() {
            const allUnits = Object.values(units);
            if (allUnits.length < 2) return; // Necesitamos al menos otros 2

            // Aquí el sistema calculará distancias. 
            // Si detecta 3 civiles en radio < 50m, cambiará el status global.
            // Para la demo, si hay más de 2 unidades, lanzamos aviso visual.
            if(allUnits.length >= 2) {
                document.getElementById('global-status').innerText = "⚠️ DETECTADA CONCENTRACIÓN ANÓMALA";
                document.getElementById('global-status').style.color = "red";
            }
        }

        async function toggleCamera() {
            const container = document.getElementById('camera-container');
            const video = document.getElementById('video-feed');
            if(!stream) {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                container.style.display = 'block';
            } else {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
                container.style.display = 'none';
            }
        }

        function triggerAlert() {
            alert("ALERTA TÁCTICA ENVIADA A CENTRAL");
        }
    </script>
</body>
</html>
